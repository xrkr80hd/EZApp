<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>4-Square Presentation Tool</title>
    <link rel="stylesheet" href="assets/css/responsive-fixes.css">
    <script src="assets/js/toast-notifications.js" defer></script>
    <script src="assets/js/loading-spinner.js" defer></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 42px;
            margin-bottom: 10px;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }

        .customer-info {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            padding: 15px 25px;
            border-radius: 12px;
            color: white;
            margin-bottom: 20px;
            text-align: center;
            font-size: 18px;
        }

        .populate-btn {
            display: block;
            width: 100%;
            max-width: 400px;
            margin: 0 auto 30px;
            padding: 20px;
            background: linear-gradient(135deg, #3498db 0%, #2ecc71 100%);
            color: white;
            border: none;
            border-radius: 15px;
            font-size: 20px;
            font-weight: 700;
            cursor: pointer;
            box-shadow: 0 8px 20px rgba(52, 152, 219, 0.4);
            transition: all 0.3s;
        }

        .populate-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 30px rgba(52, 152, 219, 0.6);
        }

        .populate-btn:active {
            transform: translateY(0);
        }

        .four-square-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .square-box {
            background: white;
            border-radius: 20px;
            padding: 30px;
            min-height: 400px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            position: relative;
            overflow: hidden;
        }

        .square-box::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 6px;
        }

        .box-1::before {
            background: linear-gradient(90deg, #e74c3c, #c0392b);
        }

        .box-2::before {
            background: linear-gradient(90deg, #3498db, #2980b9);
        }

        .box-3::before {
            background: linear-gradient(90deg, #9b59b6, #8e44ad);
        }

        .box-4::before {
            background: linear-gradient(90deg, #2ecc71, #27ae60);
        }

        .square-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #eee;
        }

        .square-icon {
            font-size: 32px;
        }

        .square-title {
            font-size: 24px;
            font-weight: 700;
            color: #333;
        }

        .square-content {
            color: #555;
            font-size: 15px;
            line-height: 1.6;
        }

        .square-content ul {
            list-style: none;
            padding: 0;
        }

        .square-content li {
            padding: 10px 0;
            padding-left: 25px;
            position: relative;
            border-bottom: 1px solid #f0f0f0;
        }

        .square-content li:last-child {
            border-bottom: none;
        }

        .square-content li::before {
            content: '‚úì';
            position: absolute;
            left: 0;
            color: #2ecc71;
            font-weight: bold;
        }

        .referral-badge {
            display: inline-block;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 15px;
        }

        .video-reminder {
            background: rgba(52, 152, 219, 0.1);
            border-left: 4px solid #3498db;
            padding: 12px;
            margin-top: 15px;
            border-radius: 5px;
            font-size: 14px;
            color: #666;
        }

        .manual-edit {
            width: 100%;
            min-height: 300px;
            padding: 15px;
            border: 2px dashed #3498db;
            border-radius: 10px;
            font-family: inherit;
            font-size: 15px;
            resize: vertical;
            background: #f8f9fa;
        }

        .manual-edit:focus {
            outline: none;
            border-color: #2980b9;
            background: white;
        }

        .action-buttons {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-top: 30px;
        }

        .btn {
            padding: 15px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-save {
            background: linear-gradient(135deg, #4CAF50, #8BC34A);
            color: white;
        }

        .btn-print {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .btn-back {
            background: linear-gradient(135deg, #3498db 0%, #2ecc71 100%);
            color: white;
        }

        .empty-state {
            color: #999;
            font-style: italic;
            padding: 20px;
            text-align: center;
        }

        .photo-thumbnails {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 15px;
        }

        .photo-thumb {
            width: 80px;
            height: 80px;
            border-radius: 8px;
            object-fit: cover;
            border: 2px solid #ddd;
            cursor: pointer;
            transition: all 0.3s;
        }

        .photo-thumb:hover {
            transform: scale(1.1);
            border-color: #3498db;
        }

        @media print {
            body {
                background: white;
                padding: 0;
            }

            .header,
            .populate-btn,
            .action-buttons {
                display: none;
            }

            .four-square-grid {
                page-break-inside: avoid;
            }
        }

        /* Tablet Responsive */
        @media (max-width: 1024px) {
            .four-square-grid {
                gap: 15px;
            }

            .square-box {
                padding: 20px;
                min-height: 350px;
            }

            .box-title {
                font-size: 16px;
            }

            .action-buttons {
                grid-template-columns: 1fr 1fr;
            }
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }

            .header h1 {
                font-size: 28px;
            }

            .four-square-grid {
                grid-template-columns: 1fr;
                gap: 15px;
            }

            .square-box {
                min-height: auto;
                padding: 20px;
            }

            .populate-btn {
                font-size: 16px;
                padding: 15px;
            }

            .action-buttons {
                grid-template-columns: 1fr;
                gap: 10px;
            }

            .customer-info {
                font-size: 15px;
                padding: 12px 15px;
            }

            button[onclick="goBack()"] {
                left: 10px;
                top: 10px;
                padding: 6px 12px;
                font-size: 12px;
            }
        }

        /* Small Mobile */
        @media (max-width: 480px) {
            .header h1 {
                font-size: 22px;
            }

            .header p {
                font-size: 13px;
            }

            .box-title {
                font-size: 14px;
            }

            .populate-btn {
                font-size: 14px;
                padding: 12px;
            }

            .photo-thumb {
                width: 60px;
                height: 60px;
            }
        }
    </style>
</head>

<body>
    <button onclick="goBack()"
        style="position: fixed; left: 20px; top: 20px; padding: 8px 16px; background: linear-gradient(135deg, #3498db 0%, #2ecc71 100%); border: none; color: white; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 13px; z-index: 100; box-shadow: 0 2px 8px rgba(52, 152, 219, 0.3);">‚Üê
        Back</button>

    <div class="container">
        <div class="header">
            <h1>üéØ 4-Square Presentation Tool</h1>
            <p>Build rapport, establish value, and close the sale</p>
        </div>

        <div class="customer-info">
            <strong>Customer:</strong> <span id="customerName">‚Äî</span>
        </div>

        <button class="populate-btn" onclick="populateFourSquare()">
            üöÄ Populate 4-Square from Survey
        </button>

        <div class="four-square-grid">
            <!-- BOX 1: LOVE THE DESIGN -->
            <div class="square-box box-1">
                <div class="square-header">
                    <div class="square-icon">‚ù§Ô∏è</div>
                    <div class="square-title">Love the Design</div>
                </div>
                <div class="square-content" id="box1Content">
                    <div class="empty-state">Click "Populate 4-Square" to load customer needs</div>
                </div>
            </div>

            <!-- BOX 2: TRUST ME -->
            <div class="square-box box-2">
                <div class="square-header">
                    <div class="square-icon">ü§ù</div>
                    <div class="square-title">Trust Me</div>
                </div>
                <div class="square-content">
                    <p style="color: #999; font-size: 14px; margin-bottom: 15px;">Add your personal connection notes:
                    </p>
                    <textarea class="manual-edit" id="box2Content"
                        placeholder="Example notes:&#10;‚Ä¢ We both love fishing at Lake Travis&#10;‚Ä¢ Her daughter goes to same school as my nephew&#10;‚Ä¢ Shared concern about aging parents&#10;‚Ä¢ Talked about our love for BBQ&#10;&#10;Add any rapport-building moments here..."></textarea>
                </div>
            </div>

            <!-- BOX 3: TRUST THE COMPANY -->
            <div class="square-box box-3">
                <div class="square-header">
                    <div class="square-icon">üè¢</div>
                    <div class="square-title">Trust the Company</div>
                </div>
                <div class="square-content" id="box3Content">
                    <div class="empty-state">Click "Populate 4-Square" to load company values</div>
                </div>
            </div>

            <!-- BOX 4: MAKE IT AFFORDABLE -->
            <div class="square-box box-4">
                <div class="square-header">
                    <div class="square-icon">üí∞</div>
                    <div class="square-title">Make It Affordable</div>
                </div>
                <div class="square-content" id="box4Content">
                    <div class="empty-state">Click "Populate 4-Square" to load budget/timeline info</div>
                </div>
            </div>
        </div>

        <div class="action-buttons">
            <button class="btn btn-save" onclick="saveFourSquare()">
                üíæ Save 4-Square
            </button>
            <button class="btn btn-print" onclick="window.print()">
                üñ®Ô∏è Print Presentation
            </button>
            <button class="btn btn-back" onclick="goBack()">
                ‚Üê Back
            </button>
        </div>
    </div>

    <script src="assets/js/ezapp-data.js"></script>
    <script src="assets/js/universal-cache.js"></script>
    <script>
        // Setup auto-cache for this page
        UniversalCache.setupAutoSave('4-square');

        window.onload = function () {
            loadCustomerName();
            // Load cached data
            UniversalCache.loadPageData('4-square');
        };

        function goBack() {
            window.location.href = 'tools.html';
        }

        function loadCustomerName() {
            const customerName = localStorage.getItem('currentCustomer') || 'No Customer Selected';
            document.getElementById('customerName').textContent = customerName;
        }

        function populateFourSquare() {
            const ezappData = EZAPPData.getCurrentData();

            if (!ezappData || !ezappData.survey) {
                alert('‚ö†Ô∏è No survey data found. Please complete the customer survey first.');
                return;
            }

            const survey = ezappData.survey;

            // BOX 1: LOVE THE DESIGN
            populateBox1(survey, ezappData.photos);

            // BOX 3: TRUST THE COMPANY
            populateBox3(survey);

            // BOX 4: MAKE IT AFFORDABLE
            populateBox4(survey);

            alert('‚úÖ 4-Square populated! Review and edit as needed.');
        }

        function populateBox1(survey, photos) {
            let html = '';

            // Number of bathrooms
            if (survey.q2_numBaths) {
                html += `<div style="margin-bottom: 15px; padding: 10px; background: rgba(52, 152, 219, 0.1); border-radius: 8px;"><strong>üõÅ Number of Bathrooms:</strong> ${survey.q2_numBaths}</div>`;
            }

            // Which bathrooms
            if (survey.q3_whichBaths) {
                html += `<div style="margin-bottom: 15px; padding: 10px; background: rgba(52, 152, 219, 0.1); border-radius: 8px;"><strong>Bathrooms:</strong> ${survey.q3_whichBaths}</div>`;
            }

            // Primary users
            if (survey.q4_primaryUsers) {
                html += `<div style="margin-bottom: 15px; padding: 10px; background: rgba(52, 152, 219, 0.1); border-radius: 8px;"><strong>üë• Primary Users:</strong> ${survey.q4_primaryUsers}</div>`;
            }

            html += '<h4 style="margin: 20px 0 10px 0; color: #3498db;">Vision & Desires</h4>';
            html += '<ul>';

            // Their vision
            if (survey.q5_vision) {
                html += `<li><strong>Their Vision:</strong> ${survey.q5_vision}</li>`;
            }

            // What they liked most (from bath they've seen)
            if (survey.q7_likedMost) {
                html += `<li><strong>What They Loved:</strong> ${survey.q7_likedMost}</li>`;
            }

            html += '</ul>';

            html += '<h4 style="margin: 20px 0 10px 0; color: #e74c3c;">Current Pain Points</h4>';
            html += '<ul>';

            // What they dislike about current
            if (survey.q9_dislikeCurrent) {
                html += `<li><strong>Current Dislikes:</strong> ${survey.q9_dislikeCurrent}</li>`;
            }

            // What they want changed
            if (survey.q10_wantChanged) {
                html += `<li><strong>Needs to Change:</strong> ${survey.q10_wantChanged}</li>`;
            }

            html += '</ul>';

            // Accessibility needs - highlight this
            if (survey.q11_accessibility && survey.q11_accessibility.toLowerCase() !== 'no' && survey.q11_accessibility.toLowerCase() !== 'none') {
                html += `<div style="margin-top: 15px; padding: 12px; background: rgba(231, 76, 60, 0.1); border-left: 4px solid #e74c3c; border-radius: 6px;"><strong>‚ö†Ô∏è Accessibility Needs:</strong> ${survey.q11_accessibility}</div>`;
            }

            // What they like about current (positive - may affect design choices)
            if (survey.q8_likeCurrent) {
                html += `<div style="margin-top: 10px; padding: 8px 12px; background: rgba(46, 204, 113, 0.1); border-radius: 6px; color: #27ae60;"><strong>‚úì Keep in Mind:</strong> They like "${survey.q8_likeCurrent}" about current bathroom</div>`;
            }

            // Add inspection photos
            if (photos && Object.keys(photos).length > 0) {
                html += '<div style="margin-top: 20px; padding-top: 20px; border-top: 2px solid #eee;">';
                html += '<strong style="display: block; margin-bottom: 10px;">Inspection Photos:</strong>';
                html += '<div class="photo-thumbnails">';

                Object.values(photos).forEach(photo => {
                    if (photo.confirmed && photo.data) {
                        html += `<img src="${photo.data}" class="photo-thumb" title="${photo.description || 'Photo'}" onclick="window.open(this.src)">`;
                    }
                });

                html += '</div></div>';
            }

            document.getElementById('box1Content').innerHTML = html;
        }

        function populateBox3(survey) {
            let html = '';

            // Referral source badge (Q1)
            if (survey.q1_hearAbout) {
                html += `<div class="referral-badge">üîó How They Heard About Us: ${survey.q1_hearAbout}</div>`;
                html += `<p style="font-size: 13px; color: #999; margin-bottom: 20px;">46% of our business comes from referrals - ask for one!</p>`;
            }

            html += '<h4 style="margin: 15px 0 10px 0; color: #9b59b6;">Home Context</h4>';
            html += '<ul>';

            // Home age
            if (survey.q12_homeAge) {
                html += `<li><strong>Home Age:</strong> ${survey.q12_homeAge}</li>`;
            }

            // Years lived there
            if (survey.q13_yearsLived) {
                html += `<li><strong>Years in Home:</strong> ${survey.q13_yearsLived}</li>`;
            }

            // Years planning to stay
            if (survey.q14_yearsPlanning) {
                html += `<li><strong>Planning to Stay:</strong> ${survey.q14_yearsPlanning}</li>`;
            }

            html += '</ul>';

            // Accessibility - show video reminder
            if (survey.q11_accessibility && survey.q11_accessibility.toLowerCase() !== 'no' && survey.q11_accessibility.toLowerCase() !== 'none') {
                html += `<div style="margin: 15px 0; padding: 10px; background: rgba(231, 76, 60, 0.1); border-radius: 8px;"><strong>üé• Show Video:</strong> Safety Features & Accessibility segment</div>`;
            }

            // Video reminder
            html += '<div class="video-reminder">';
            html += 'üìπ <strong>Remember:</strong> Play the company video segments that match their situation';
            html += '</div>';

            document.getElementById('box3Content').innerHTML = html;
        }

        function populateBox4(survey) {
            let html = '';

            html += '<h4 style="margin: 0 0 10px 0; color: #27ae60;">Timeline & Decision</h4>';
            html += '<ul>';

            // How long considering
            if (survey.q15_howLongConsidering) {
                html += `<li><strong>Been Considering:</strong> ${survey.q15_howLongConsidering}</li>`;
            }

            // What prevented them
            if (survey.q16_whatPrevented) {
                html += `<li><strong>What Held Them Back:</strong> ${survey.q16_whatPrevented}</li>`;
            }

            // Other projects being considered
            if (survey.q17_otherProjects) {
                html += `<li><strong>Competing Projects:</strong> ${survey.q17_otherProjects}</li>`;
            }

            html += '</ul>';

            html += '<h4 style="margin: 20px 0 10px 0; color: #27ae60;">üí∞ Payment Details</h4>';
            html += '<ul>';

            // Funding method
            if (survey.q18_fundingMethod) {
                html += `<li><strong>Funding Method:</strong> ${survey.q18_fundingMethod}</li>`;
            }

            // Cash timing (if applicable)
            if (survey.q19_cashTiming) {
                html += `<li><strong>Cash Timing:</strong> ${survey.q19_cashTiming}</li>`;
            }

            // Monthly payment range (if financing)
            if (survey.q20_monthlyRange) {
                html += `<li><strong>Monthly Range:</strong> ${survey.q20_monthlyRange}</li>`;
            }

            // Deposit amount
            if (survey.q21_deposit) {
                html += `<li><strong>Deposit Capability:</strong> ${survey.q21_deposit}</li>`;
            }

            html += '</ul>';

            html += '<div style="margin-top: 20px; padding: 15px; background: rgba(46, 204, 113, 0.1); border-radius: 10px; border-left: 4px solid #2ecc71;">';
            html += '<strong>üí° Focus:</strong> This is where you make it work financially. Payment options, financing, value justification.';
            html += '</div>';

            html += '<div style="margin-top: 15px; text-align: center;">';
            html += '<button onclick="window.location.href=\'commission_calculator.html\'" style="padding: 12px 20px; background: linear-gradient(135deg, #2ecc71, #27ae60); color: white; border: none; border-radius: 10px; font-weight: 600; cursor: pointer;">üí∞ Go to Commission Calculator</button>';
            html += '</div>';

            document.getElementById('box4Content').innerHTML = html;
        }

        function saveFourSquare() {
            const customerName = localStorage.getItem('currentCustomer').replace(/[^a-zA-Z0-9]/g, '_');
            const existingKeys = Object.keys(localStorage).filter(key => key.startsWith(`four_square_${customerName}_`));

            // Check if overwriting
            if (existingKeys.length > 0) {
                const confirmed = confirm('‚ö†Ô∏è A 4-Square is already saved for this customer.\n\nDo you want to overwrite the previous save?');
                if (!confirmed) {
                    return;
                }
                // Clear old saves
                existingKeys.forEach(key => localStorage.removeItem(key));
            }

            const fourSquareData = {
                customerName: document.getElementById('customerName').textContent,
                timestamp: new Date().toISOString(),
                box1: document.getElementById('box1Content').innerHTML,
                box2: document.getElementById('box2Content').value,
                box3: document.getElementById('box3Content').innerHTML,
                box4: document.getElementById('box4Content').innerHTML
            };

            const key = `four_square_${customerName}_${Date.now()}`;

            localStorage.setItem(key, JSON.stringify(fourSquareData));
            localStorage.setItem('last_four_square', JSON.stringify(fourSquareData));

            // Clear cache after save
            UniversalCache.clearPageCache('4-square');

            // Show confirmation
            UniversalCache.showSaveConfirmation('‚úì 4-Square saved successfully!');
        }

        // Load last saved 4-square if it exists
        const lastSaved = localStorage.getItem('last_four_square');
        if (lastSaved) {
            const data = JSON.parse(lastSaved);
            if (data.customerName === localStorage.getItem('currentCustomer')) {
                if (confirm('üìã Load previously saved 4-Square for this customer?')) {
                    document.getElementById('box1Content').innerHTML = data.box1;
                    document.getElementById('box2Content').value = data.box2;
                    document.getElementById('box3Content').innerHTML = data.box3;
                    document.getElementById('box4Content').innerHTML = data.box4;
                }
            }
        }
    </script>
</body>

</html>